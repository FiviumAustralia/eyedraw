<!DOCTYPE html>
<meta charset="utf-8" />
<html>
    <head>
        <title>EyeDraw</title>

        <!-- EyeDraw CSS style sheet -->
        <link rel="stylesheet" href="../../assets/css/oe-eyedraw.css" type="text/css" media="screen" />
        <style>
        	.ed-button {
		  display: inline;
		}

		.ed-doodle-popup {
			border-width: 1px 1px 1px 1px;
		}
        </style>

        <!-- Depedendant 3rd-party libraries -->

        <script type="text/javascript" src="../../assets/components/jquery/jquery.min.js"></script>
				<script type="text/javascript" src="../../assets/components/mustache/mustache.js"></script>
				<script type="text/javascript" src="../../assets/components/eventemitter2/lib/eventemitter2.js"></script>

        <!-- Mandatory file containing key drawing classes -->
        <script src="../../assets/js/dist/eyedraw.js" type="text/javascript"></script>

        <!--   This script handles the drawings for the page   -->
        <script type="text/javascript">

            //var doodleSet = [{"version": 1.0, "subclass": "Patch", "originX": -130, "originY": -183, "apexX": -50, "rotation": 325, "order": 0, }];


        	var doodleSet = [{"subclass": "OpticDisc", "originX": 0, "originY": 0, "radius": 200, "apexX": -13, "apexY": -167, "scaleX": 1.00, "scaleY": 1.00, "arc": 180, "rotation": 0, "order": 0, "squiggleArray": [{"colour": {"red":100,"green":100,"blue":100,"alpha":1}, "thickness": 4, "filled": "true", "pointsArray": []}], "mode" : "Basic"}];


            // This set can be written by PHP and contains doodle data for this drawing from a database
            //var doodleSet = [{"subclass": "PhakoIncision", "originX": 0, "originY": 0, "radius": 250, "apexX": 0, "apexY": -250, "scaleX": 1.00, "scaleY": 1.00, "arc": 90, "rotation": 319, "order": 0, "squiggleArray": []}];


            // Unique variable assigned to the drawing
            var drawingEdit;
            var drawingDisplay;
            var doodle;
            var controller;

            var grid;

            // Runs on page load
            function init()
            {
                // Get reference to the drawingEdit canvas
                var canvasEdit = document.getElementById('canvasEdit');

                // Create a drawingEdit , {scaleOn:'width'}
                drawingEdit = new ED.Drawing(canvasEdit, ED.eye.Right, 'RPS', true, {graphicsPath:'../../assets/img/', toggleScale:0.72});

                // Instantiate a controller object
                controller = new eyeDrawController(drawingEdit);

                // Initialise drawing
                drawingEdit.init();

                // Set focus to canvasEdit element
                //canvasEdit.focus();
            }


            // Controller class
            function eyeDrawController(_drawing)
            {
                this.drawing = _drawing;
                this.gsf = 1;
                //this.gsf = 0.72;

                // Specify call back function
                this.callBack = callBack;

                // Register for notifications with drawing object
                this.drawing.registerForNotifications(this, 'callBack', []);

                // Show doodle controls
                this.drawing.showDoodleControls = true;

                // Method called for notification
                function callBack(_messageArray)
                {
                    switch (_messageArray['eventName'])
                    {
                        // Eye draw image files all loaded
                        case 'ready':

					//Scale down for glaucoma drawings
					this.drawing.globalScaleFactor = this.gsf;

					//this.drawing.addDoodle('AxialLengthGraph', {'axialLength':'25'});
					//this.drawing.addDoodle('Fundus', {'pupilSize':'Medium'});
					//this.drawing.addDoodle('Patient', {}, {recliningAngle:{id:'recliningAngleInput'}});
					//this.drawing.addDoodle('TrialLens', {}, {axis:{id:'axis'}});
					//this.drawing.addDoodle('ToricPCIOL', {}, {axis:{id:'axis'}});
					//this.drawing.addDoodle('CiliaryInjection');
					//this.drawing.addDoodle('CornealGraft', {}, {diameter:{id:'diameter'}});
					//this.drawing.addDoodle('DrainageRetinotomy');
					//this.drawing.addDoodle('DendriticUlcer');
					//this.drawing.addDoodle('Episcleritis');
					this.drawing.addDoodle('Chart');
 					//this.drawing.addDoodle('Fracture');
					//this.drawing.addDoodle('Crown');
					this.drawing.addDoodle('DoubleCaries');
					//this.drawing.addDoodle('Rotation');
					this.drawing.deselectDoodles();


					break;

                        case 'parameterChanged':
					var doodle = _messageArray['object'].doodle;
					addToReport();

					break;

                        case 'doodleSelected':
                        	var doodle = this.drawing.selectedDoodle;
                        	if (doodle.showPopup) {
						var propWindow = document.getElementById('canvasEdit_controls');
						propWindow.style.visibility = 'visible';
						propWindow.style.left = (this.drawing.selectedDoodle.originX * this.drawing.scale + 530).toString() + 'px';
						propWindow.style.top = (this.drawing.selectedDoodle.originY * this.drawing.scale + 80).toString() + 'px';
                        	}
                        	break;

                        case 'doodleDeselected':
                        	if (this.drawing.selectedDoodle == null) {
						var propWindow = document.getElementById('canvasEdit_controls');
						propWindow.style.visibility = 'hidden';
                        	}
                        	break;

                        case 'doodleAdded':
					var dood = _messageArray['object'];
					var propWindow = document.getElementById('canvasEdit_controls');
					if (typeof(dood) != 'undefined' &&  dood.showPopup) {
						propWindow.style.visibility = 'visible';
						propWindow.style.left = (this.drawing.selectedDoodle.originX * this.drawing.scale + 530).toString() + 'px';
						propWindow.style.top = (this.drawing.selectedDoodle.originY * this.drawing.scale + 80).toString() + 'px';
					}
					else {
						propWindow.style.visibility = 'hidden';
					}
					addToReport();
					break;

                        case 'doodleDeleted':
					var deletedClass = _messageArray['object'];
					if (typeof(deletedClass) != 'undefined') {

						// Get Chart doodle
						var chartDoodle = this.drawing.lastDoodleOfClass('Chart');

						// If there is a chart, interrogate box array to get position
						if (chartDoodle) {
							// Reset occupied flag to false
							for (var i = 0; i < chartDoodle.boxArray.length; i ++ ) {
								chartDoodle.boxArray[i].occupied = false;
							}
							// Go through again restoring valid flags
							for (var i = 0; i < chartDoodle.boxArray.length; i ++ ) {
								for (var index in this.drawing.doodleArray) {
									var doodle = this.drawing.doodleArray[index];
									if (doodle.className != "Chart") {
										var p = chartDoodle.boxArray[i].point;
										if (p.x == doodle.originX && p.y == doodle.originY) {
											chartDoodle.boxArray[i].occupied = true;
										}
									}
								}
							}
						}
					}
					var propWindow = document.getElementById('canvasEdit_controls');
					propWindow.style.visibility = 'hidden';
					addToReport();
					break;

					case 'mousedown':
					addToReport();
					break;

                    }
                }
            }

		function addToReport()
		{
			// Get text from the applet and force into string type
			var text = drawingEdit.report();

			// Use a RegEx to comma and space
			text = text.replace(/, /g, '');
			text = text.replace(/Â£/g,'\n');

			// Get reference to report textarea
			var repText = document.getElementById('report');

			// Add to existing text in text area
			repText.innerHTML = text;
		}

            </script>
    </head>

    <body onload="init();">

		<!-- Doodle controls toolbar -->
		<div class="ed-toolbar" >
<!--
			<button class="ed-button" id="moveToFrontRPS" title="Move to front" onclick="drawingEdit.moveToFront(); return false;" ><img src="../../assets/img/old/moveToFront.gif"/></button>
			<button class="ed-button" id="moveToBackRPS" title="Move to back" onclick="drawingEdit.moveToBack(); return false;" ><img src="../../assets/img/old/moveToBack.gif" /></button>
			<button class="ed-button" id="flipVerRPS" title="Flip around vertical axis" onclick="drawingEdit.flipVer(); return false;" ><img src="../../assets/img/old/flipVer.gif" /></button>
			<button class="ed-button" id="flipHorRPS" title="Flip around horizontal axis" onclick="drawingEdit.flipHor();
return false;" ><img src="../../assets/img/old/flipHor.gif" /></button> -->
			<button class="ed-button" id="deleteSelectedDoodleRPS" title="Delete" onclick="drawingEdit.deleteSelectedDoodle(); return false;" ><img src="../../assets/img/old/deleteSelectedDoodle.gif" /></button>
<!--
			<button class="ed-button" id="lockRPS" title="Lock" onclick="drawingEdit.lock(); return false;" ><img src="../../assets/img/old/lock.gif" /></button>
			<button class="ed-button" id="unlockRPS" title="Unlock" onclick="drawingEdit.unlock(); return false;" ><img src="../../assets/img/old/unlock.gif" /></button>

			<label style="display:none;" ><input class="checkbox" type="checkbox" id="isSuturedSclerostomyRPS" onchange="drawingEdit.setSelectedDoodle(this, 'isSutured');return false;" />Sutured</label>
 -->


			<br />
		</div>

		<!-- Doodle selection toolbar -->
		<div class="ed-toolbar" id="canvasEdit1doodleToolbar">
			<button id="LensRPS" class="ed-button" title="Normal" onclick="drawingEdit.addDoodle('Normal'); return false;" ><img src="../../assets/img/old/Normal.gif" /></button>
			<button id="LensRPS" class="ed-button" title="Missing" onclick="drawingEdit.addDoodle('Missing'); return false;" ><img src="../../assets/img/old/Missing.gif" /></button>
			<button id="LensRPS" class="ed-button" title="Caries" onclick="drawingEdit.addDoodle('Caries'); return false;" ><img src="../../assets/img/old/Caries.gif" /></button>
			<button id="LensRPS" class="ed-button" title="Restoration" onclick="drawingEdit.addDoodle('Restoration'); return false;" ><img src="../../assets/img/old/Restoration.gif" /></button>
			<button id="LensRPS" class="ed-button" title="Double Restoration" onclick="drawingEdit.addDoodle('DoubleRestoration'); return false;" ><img src="../../assets/img/old/DoubleRestoration.gif" /></button>
			<button id="LensRPS" class="ed-button" title="Fracture" onclick="drawingEdit.addDoodle('Fracture'); return false;" ><img src="../../assets/img/old/Fracture.gif" /></button>
			<button id="LensRPS" class="ed-button" title="Implant" onclick="drawingEdit.addDoodle('Implant'); return false;" ><img src="../../assets/img/old/Implant.gif" /></button>
			<button id="LensRPS" class="ed-button" title="Extracted" onclick="drawingEdit.addDoodle('Extracted'); return false;" ><img src="../../assets/img/old/Extracted.gif" /></button>
			<button id="LensRPS" class="ed-button" title="Canine" onclick="drawingEdit.addDoodle('Canine'); return false;" ><img src="../../assets/img/old/Canine.gif" /></button>
			<button id="LensRPS" class="ed-button" title="Rotation" onclick="drawingEdit.addDoodle('Rotation'); return false;" ><img src="../../assets/img/old/Rotation.gif" /></button>

			<button id="LensRPS" class="ed-button" title="Tooth Surface Loss" onclick="drawingEdit.addDoodle('SurfaceLoss'); return false;" ><img src="../../assets/img/old/SurfaceLoss.gif" /></button>
			<br />
		</div>

		<!-- Canvas -->
		<div style="position:relative;">
			<span id="canvasTooltip"></span>
			<canvas id="canvasEdit" class="ed-canvas" width="1000" height="300" tabindex="1"></canvas>
			<!-- Doodle control panel -->
			<div id="canvasEdit_controls" class="ed-doodle-popup" style="background-color: #DAE6F1; position:absolute; left:50px; top:20px; visibility:hidden;">
			</div>

		</div>

		<!-- Report -->
		<textarea id="report" style="color: #0000FF; height: 700px; width: 500px; border: none; font-size: 18px;"></textarea>


    </body>
</html>
